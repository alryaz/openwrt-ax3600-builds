name: Build OpenWrt for specific target and release

on:
  workflow_dispatch:
  # push:
  # schedule:
  #   - cron: "0 */2 * * *"

env:
  REMOTE_REPOSITORY: qosmio/openwrt-ipq
  REMOTE_BRANCH: main-nss
  CONFIG_FILE: ax3600.config
  CUSTOM_FILES_PATH: files/
  RELEASE_PREFIX: main-nss
  NSS_PACKAGES_REPOSITORY: qosmio/nss-packages
  NSS_PACKAGES_REPOSITORY_BRANCH: NSS-12.5-K6.x

jobs:
  build:
    name: Test cloning mechanisms
    runs-on: ubuntu-24.04
    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt full-upgrade -y
          sudo apt install -y \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3-setuptools rsync swig unzip zlib1g-dev file wget

      - name: Test 1. Root dir
        uses: actions/checkout@v4
        with:
          repository: ${{ env.REMOTE_REPOSITORY }}
          ref: ${{ env.REMOTE_BRANCH }}

      - name: Check .git and else
        run: |
          ./scripts/getver.sh
          ls -alh

      - name: Test 2. Subdir
        uses: actions/checkout@v4
        with:
          repository: ${{ env.REMOTE_REPOSITORY }}
          ref: ${{ env.REMOTE_BRANCH }}
          path: orig_repo_other

      - name: Check .git and else
        run: |
          cd "${{ github.workspace }}/orig_repo_other"
          ./scripts/getver.sh
          ls -alh

      - name: Test 3. Separate clone, single branch
        run: git clone https://github.com/${{ env.REMOTE_REPOSITORY }}.git "${{ github.workspace }}/single_branch" --branch "${{ env.RELEASE_PREFIX }}" --single-branch 

      - name: Check .git and else
        run: |
          cd "${{ github.workspace }}/single_branch"
          ./scripts/getver.sh
          ls -alh

      - name: Test 4. Separate clone, single branch
        run: git clone https://github.com/${{ env.REMOTE_REPOSITORY }}.git "${{ github.workspace }}/multip_branch" --branch "${{ env.RELEASE_PREFIX }}"

      - name: Check .git and else
        run: |
          cd "${{ github.workspace }}/multip_branch"
          ./scripts/getver.sh
          ls -alh
